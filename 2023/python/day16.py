from collections import defaultdict
def solve1(s):
  a = s.strip().split("\n")
  # for x in a: print(x)
  n, m = len(a), len(a[0])
  
  vis = set()
  q = []

  source = (0, 0, 'R')

  vis.add(source)
  q += [source]

  def add(i, j, d):
    if not (0 <= i < n and 0 <= j < m): return
    tu = (i, j, d)
    if tu not in vis:
      vis.add(tu)
      q.append(tu)

  while len(q):
    i, j, d = q[0]
    q = q[1:]
    if a[i][j] == '.':
      if d == 'R': add(i, j + 1, d)
      elif d == 'L': add(i, j - 1, d)
      elif d == 'U': add(i - 1, j, d)
      elif d == 'D': add(i + 1, j, d)
    elif a[i][j] == "\\":
      if d == 'R': add(i + 1, j, 'D')
      elif d == 'L': add(i - 1, j, 'U')
      elif d == 'U': add(i, j - 1, 'L')
      elif d == 'D': add(i, j + 1, 'R')
    elif a[i][j] == '/':
      if d == 'R': add(i - 1, j, 'U')
      elif d == 'L': add(i + 1, j, 'D')
      elif d == 'U': add(i, j + 1, 'R')
      elif d == 'D': add(i, j - 1, 'L')
    elif a[i][j] == '-':
      if d == 'R': 
        add(i, j + 1, 'R')
      elif d == 'L': 
        add(i, j - 1, 'L')
      elif d == 'U' or d == 'D': 
        add(i, j - 1, 'L')
        add(i, j + 1, 'R')
    elif a[i][j] == '|':
      if d == 'R' or d == 'L': 
        add(i - 1, j, 'U')
        add(i + 1, j, 'D')
      elif d == 'U': 
        add(i - 1, j, d)
      elif d == 'D': 
        add(i + 1, j, d)
    else:
      pass
  seen = set((x, y) for x, y, v in vis)
  ans = len(seen)
  print("Part 1:", ans)
def solve2(s):
  a = s.strip().split("\n")
  # for x in a: print(x)
  n, m = len(a), len(a[0])
  starts = []
  for i in range(n): starts += [(i, 0, 'R'), (i, m - 1, 'L')]
  for j in range(m): starts += [(0, j, 'D'), (n - 1, j, 'U')]
  maxans = 0
  for si, sj, sd in starts:
    vis = set()
    q = []

    source = (si, sj, sd)

    vis.add(source)
    q += [source]

    def add(i, j, d):
      nonlocal q, n, m
      if not (0 <= i < n and 0 <= j < m): return
      tu = (i, j, d)
      if tu not in vis:
        vis.add(tu)
        q += [tu]

    while len(q):
      i, j, d = q[0]
      q = q[1:]
      if a[i][j] == '.':
        if d == 'R': add(i, j + 1, d)
        elif d == 'L': add(i, j - 1, d)
        elif d == 'U': add(i - 1, j, d)
        elif d == 'D': add(i + 1, j, d)
      elif a[i][j] == "\\":
        if d == 'R': add(i + 1, j, 'D')
        elif d == 'L': add(i - 1, j, 'U')
        elif d == 'U': add(i, j - 1, 'L')
        elif d == 'D': add(i, j + 1, 'R')
      elif a[i][j] == '/':
        if d == 'R': add(i - 1, j, 'U')
        elif d == 'L': add(i + 1, j, 'D')
        elif d == 'U': add(i, j + 1, 'R')
        elif d == 'D': add(i, j - 1, 'L')
      elif a[i][j] == '-':
        if d == 'R': 
          add(i, j + 1, 'R')
        elif d == 'L': 
          add(i, j - 1, 'L')
        elif d == 'U' or d == 'D': 
          add(i, j - 1, 'L')
          add(i, j + 1, 'R')
      elif a[i][j] == '|':
        if d == 'R' or d == 'L': 
          add(i - 1, j, 'U')
          add(i + 1, j, 'D')
        elif d == 'U': 
          add(i - 1, j, d)
        elif d == 'D': 
          add(i + 1, j, d)
      else:
        pass
    seen = set((x, y) for x, y, v in vis)
    ans = len(seen)
    maxans = max(maxans, ans)
  print("Part 2:", maxans)
def solve(s):
  solve1(s)
  solve2(s)

solve(r"""
.|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|....
""")

solve(r"""
\....\..-...........|..\........|.........|./.\..............\................/.....-............./...........
......-........../.........--........................|..-../.............................-\.....|.............
....-.-........................................................../..........................|...|......\|.....
....\.-......\|...............................-|........\.............................../......\..............
..|.|.|...-..-...-..................--........../.......................|.\-.../....................-....\....
....\...................|..............|..../../.......................\......................................
...............\.|..............\........\.\.-...--..-...\........................|.|.........................
..........-........\............-....|...|.............\.\...............\./............./....................
...\.....\.\...............||...........................................-...............-...../...|...........
......./......./....-..../...-........./././\..||.......-.|.......\.........\|................./........-.....
......................|./...|......................./...|....\................-....|....|.\...|.../......../..
.\...........\-......\.\|..\\..-|//../............/...............................-........|..|............-..
..|.............../.............|..-./..\....-|...........................-.|......|....\\......-..../...\....
............\......\|.../...............-......./.........\.\.\.../.|.........................................
....\-......./-........../....................|.........-......../........-.............\..|...../...-........
|.................|....................-.............|...........-.-....-...-......-................./|.\.....
|................/......./.........|.........................-/...........|.................\-/|.........\../.
...................-..............\................|..../.||.-....\...............-......................\..\.
.......|......\..-....-...............\.....|../..\..-...........|......../....\.././..........\.|........-..\
..\..|............|....\......../............-.\.................................-............-............\..
.........|.....\...........................................|....|............../..-.............../...........
...........-................................\...../....|.....|..............|.................................
./........................\..\...........................|.|................................-.................
......|\./....................|..../.........\......|.\..-.|.....|........./........|.........-.-.............
.........\.....................-.................\.....|...................../........./..............|.......
.................-.........\........\.....-...................\.....-..\........../........................./|
............|...........-....\..\............-....-........................|...|........../.............\.....
........................................../............/..................\............\..../......\../.......
......../..........-.....-...................../......................-......\..../..\.-...../....|.|....-....
\.........\.......-.................\.......\-......|.......\......................\......................-...
.........../.................|....................................|...\..../.../|.............................
..\.......................\...........-..\...../.................\.\..-................-...........|..........
...../.../............................\............................../.-../........\.-...|....................
...|....\.\...\...........-............\.............|............\.........................../........./.....
........../......../................/.../........................|............-......................\......./
.../............................-.....-...|.......\....................|...............\......................
......|..-|\..\............../.\.............-....-.......\................./.././/......../.....|....../|....
.............\.........\.......\........-...........||.......|...-.............\........./................/.|.
...\...../.-.....................-..........................-..-............../...../......|..|......|......\.
...|................|.............................|........./....\.....\...................................\..
..............-......................../........\.......................|.\/................-.........\.......
.\........\..\.....-.......\.-.-......................\..-........../................../..................--..
........|.....-.......|.../../..........|........\..|...../..\....../..|...............\|.....................
..........|...../........|....../..........-..-................../....-..........|............................
|...............-......../......./..................\.............\..........|.......\............||..........
........|.........|...............|.........../|..-\..........|....|...\..|\.\...............|-..-............
/......./.............-.....-.......\......-./.......\..\............|...\..\...../...............-.\.........
.-.........|....../.............|........|.......|.....-..............-....../............|............-/\....
..-...|........-...............-........\......../.-........................-................../-.......|.....
...\.-.....................-............................\...................||.....-..........\......\..../...
..........\./........\.||\...|..........-...../.......\.///......../...|...................../....--..........
.....\........./../.............-|...-..---.................../....|...\.../.....|./..........|...../.........
/..........-...../........-.................../..................\./.|..............-...-...............|.....
............\.............\..................................\|....|.../.....|..........\..................|..
...........\........./......\.................................../...-.....\.............\..|...........-......
.............\..-......................\.......|.../...............\.....-...|...|............................
................|-...................../|...|......................................\.............|.......|....
..|........./.................../...................../.....|.-...\............-.............................\
|.\........\.-..........|..|.........|\.-|\\.-....-...............................|....|...........-..|.....-.
./................|.|..|......\.....................-..........\........-...................../......|........
........../.........../............../...||..-.........|....\.\.......|..../.......|............./.-......./..
.........\.\.......-................/.../....|...................\.\|./...../........\.....................|..
..............|........-................|..............|.....-.-................\.........|......./......-....
.........................../.-.-...........................-................-.....-.............|.........\.\.
....|....|.../..........................|............................-...........--....../..|.............\\|.
......./...../..............-...............\|............/-..............................-/.....-.\..........
....-........-....\\.....|../.....-......../.............|.............|...../.......\\....../.........|......
......................-.../.................................................................-..../........|.-/
.................|...........-..|.-.......|............/................./......-.....................-.|.....
|...|.........\.|\..\....../..........-......\\......\.....................\/../.........../..../..-...|.|....
.|.|....|.....|\............./.|......-......-............/....-...-......../-|...............................
....../..............\............../....\..............\............|..\.........|....................|......
.........................\|.......-..........................................................\|...............
...............\.........|../.....-......\..................-.........................-..............-......|.
.....|...|.-...........................\..........\......\../.................-...............-........\......
.|........../........../..............|..../...../...|........-......../.\..........\......................-..
.............-|..................../.......-.../......-.../......./......|..........-./.......................
...\.........|.|...................|../.|...........|....................///....-.........-......./.......|...
.\........-.\..................................-\../...../..\......\...................../|.......-...........
........\..................\.......|...|................../\............|........-............\||.../..-../...
.............\..|/...................../....|.|...//....../|............\..\..|.......-..............-........
.........|/..................-............/....../............/....||.........................................
.|............-........|.........-//..........-................../........../..-...............|..|.......\...
........|.../......-..|.\..|..................|./....|.....-................................/.........../.....
..............-..........|......../.................................../.....\.............../.../..\..|/......
--................\...............|.........-.....|...../.........................-.....-.\\..........\.......
.......\.........\.................-..................../......\.....................\.................-......
....|....|......|...\.........\......../............/..../....\.......\...\....\.........|...................|
..........|....\\.............|........./.....|............../...-/...-.||......./......\.....................
..-./..-./.|...............-/.-.............|...............................\.....-...........................
/......|..|\........\........../...................-.\.......-...............-..\.......|.......|..-..........
./..\................................/.-..................-................-......../.......-.....|...........
............|..|.....\............\.\............\......|.-....../........\..|............../...........|.....
...|....|............|......../....|.|............./......................................|....../.|..-.......
............\......\........-.../....................-./....-.../.\....|........|......-...\........../.......
...........................-................./.......\...........................-.......\....................
.-.-.......|.......|.......-..................................../......-\......./..\.-.............-..........
.............../............-...................|..........................\.-..............\.................
..................................../|..............................|.../....\............/|.........\......./
.\...../\.-.........../....-.-|................./.../..../..........|..................................|.....-
..|......................\..................-...........\....-........\......-...-..-........................|
..-.......-......................\....-...........................|.......-../-...-......................|....
.............-..........................|..................................\./.........................-...../
....\......|........................|..................../........................|.|\.......\......../......\
.../........./..................\..../.../\............|.......|...\.\...../...\.....-...........|..|.\.......
....\../..................\...|.........|../..../.......................|..........-...|....\../............./
../......-......\.......\...........\|.......|...-./..........|................|../|......./..................
........../\/............................-.....|...-..|...............|.........................-.\...........
......................|..........\..................../..-........-...../.........-........./.........../.....
/.........-...................\.-\..............\...\....\.......\...|....................../.........|.......
""")